# 应用流程重构文档 (Application Flows Refactoring)

**项目名称**: [项目名称]  
**重构目标**: [重构目标]  
**源系统路径**: [源代码路径]  
**提取日期**: [日期]  
**分析范围**: [重构涉及的模块/功能范围]

**工具辅助说明**: 本文档使用交互元素发现工具 (`interactive-element-discovery.py`) 进行系统化分析，确保完整捕获所有用户交互和事件处理逻辑。

---

## 1. 交互元素发现分析 (Interactive Element Discovery Analysis)

### 1.1 工具执行结果

**发现统计**: 
- 总交互元素数量: [数量]
- 关键交互元素 (P0): [数量]  
- 重要交互元素 (P1): [数量]
- 一般交互元素 (P2): [数量]

**组件复杂度分析**:
- 最复杂组件: [组件名称] ([元素数量] 个交互元素)
- 主要交互类型: [类型] ([百分比]%)

**执行命令**:
```bash
python3 .specify/scripts/interactive-element-discovery.py --source [源代码路径] --output interactive-elements.json --format json
```

### 1.2 关键交互元素清单

基于工具发现的 [数量] 个交互元素，按重要性分类：

#### P0级别 - 关键交互元素
1. **[元素类型]**: [元素名称]
   - 位置: [file_path]:[line_number]
   - 组件: [组件名称]
   - 用户操作: [用户操作描述]
   - 系统响应: [系统响应描述]
   - 交互类别: [navigation/data_manipulation/media_control/ui_interaction]

#### P1级别 - 重要交互元素
1. **[元素类型]**: [元素名称]
   - 位置: [file_path]:[line_number]
   - 组件: [组件名称]
   - 用户操作: [用户操作描述]
   - 系统响应: [系统响应描述]

---

## 2. 现有系统流程分析 (Current System Flow Analysis)

### 2.1 基于交互元素的流程提取

#### 流程: [流程名称]
**源位置**: [file_path]:[line_number]  
**业务重要性**: [高/中/低]  
**重构影响**: [关键/一般/无影响]  
**宪法符合性**: [I. Behavior Preservation + VI-E. Direct Replacement Refactoring]

**现有流程步骤**:
1. **步骤1**: [步骤描述] 
   - 源代码位置: [file_path]:[line_number]
   - 触发条件: [条件描述]
   - 用户操作: [具体操作]
   - 系统响应: [系统反馈]
   - 数据变化: [数据状态变更]

2. **步骤2**: [步骤描述]
   - 源代码位置: [file_path]:[line_number]
   - 触发条件: [条件描述]
   - 用户操作: [具体操作]
   - 系统响应: [系统反馈]
   - 数据变化: [数据状态变更]

**现有业务规则**:
- **规则1**: [rule_description] (位置: [file_path]:[line_number])
- **规则2**: [rule_description] (位置: [file_path]:[line_number])

**异常处理机制**:
- **异常1**: [异常描述] 
  - 处理方式: [现有处理逻辑]
  - 源位置: [file_path]:[line_number]
- **异常2**: [异常描述]
  - 处理方式: [现有处理逻辑]
  - 源位置: [file_path]:[line_number]

### 1.2 关键流程映射表

| 流程ID | 流程名称 | 源文件位置 | 业务重要性 | 重构约束 | 验证方法 |
|--------|----------|------------|------------|----------|----------|
| FLOW-001 | [流程名] | [file_path]:[line_number] | P0/P1/P2 | [保持/优化] | [验证方式] |
| FLOW-002 | [流程名] | [file_path]:[line_number] | P0/P1/P2 | [保持/优化] | [验证方式] |

---

## 2. 用户界面状态分析 (UI State Analysis)

### 2.1 现有界面状态机

#### 组件/页面: [ComponentName]
**源位置**: [file_path]:[line_number]  
**组件类型**: [页面/组件/指令]  
**重构要求**: [完全保持/可优化]

**现有状态定义**:
| 状态名称 | 状态值 | 触发条件 | 退出条件 | 源代码位置 |
|----------|--------|----------|----------|------------|
| [state] | [value] | [trigger] | [exit_condition] | [file_path]:[line_number] |
| [state] | [value] | [trigger] | [exit_condition] | [file_path]:[line_number] |

**状态转换逻辑**:
```typescript
// 源系统中的状态转换代码
if ([condition]) {
  this.[state] = '[new_state]';
  // 相关副作用
  [side_effects]
}
```

### 2.2 用户交互事件分析

#### 交互事件: [EventName]
**源位置**: [file_path]:[line_number]  
**事件类型**: [click/change/input/custom]  
**业务影响**: [高/中/低]

**现有事件处理流程**:
1. **事件触发**: [触发条件]
2. **数据验证**: [验证逻辑] (位置: [file_path]:[line_number])
3. **业务逻辑**: [处理逻辑] (位置: [file_path]:[line_number])
4. **状态更新**: [更新逻辑] (位置: [file_path]:[line_number])
5. **界面反馈**: [反馈机制] (位置: [file_path]:[line_number])

**关键约束**:
- [x] **Constitution I**: 事件触发条件必须保持完全一致（Behavior Preservation）
- [x] **Constitution I**: 处理顺序不能改变（Behavior Preservation）
- [x] **Constitution I**: 数据验证必须保持（Behavior Preservation）
- [ ] **Constitution VI-A**: UI反馈可以优化（Frontend-Specific Allowances）

**重构合规性要求**:
- [x] **Constitution VI-E**: 直接替换重构，新前端必须实现100%相同的行为
- [x] **Constitution II**: 接口稳定性，所有公开接口保持不变
- [x] **Constitution VI-C**: 数据真实性，严禁使用假数据
- [x] **Constitution VI-D**: 接口和模型完整性，严禁自定义定义
- [x] **Constitution VI-F**: 前端路由100%保留，路由配置和导航行为必须完全保持

**前端路由配置分析**:
#### 路由配置: [RouteConfigName]
**源位置**: [file_path]:[line_number]  
**路由类型**: [模块路由/组件路由/嵌套路由]  
**重构约束**: [Constitution VI-F - 100%保持]

**现有路由定义**:
```typescript
// 源系统中的路由配置
const routes: Routes = [
  {
    path: '[route_path]',
    component: [ComponentName],
    children: [child_routes]  // 如果有嵌套路由
  }
];
```

**路由关键特性**:
- **路径模式**: [path_pattern] (必须100%保持)
- **参数配置**: [param_config] (必须100%保持)
- **路由守卫**: [route_guards] (必须100%保持)
- **数据解析**: [resolve_data] (必须100%保持)
- **查询参数**: [query_params] (必须100%保持)

**导航逻辑**:
- **程序化导航**: [navigation_code] (位置: [file_path]:[line_number])
- **路由链接**: [router_links] (位置: [file_path]:[line_number])
- **重定向规则**: [redirect_rules] (位置: [file_path]:[line_number])

### 2.2 界面状态转换

#### 页面/组件: [页面或组件名称]
**初始状态**: [初始状态描述]

| 状态 | 触发条件 | 界面表现 | 可用操作 |
|------|----------|----------|----------|
| [状态1] | [触发条件] | [界面表现] | [可用操作列表] |
| [状态2] | [触发条件] | [界面表现] | [可用操作列表] |

### 2.3 数据流映射

#### 数据流: [数据流名称]
**源**: [数据来源]  
**目标**: [数据目标]  
**触发**: [触发条件]

**数据转换过程**:
1. [转换步骤1]
2. [转换步骤2]
3. [转换步骤3]

---

## 3. 业务逻辑映射

### 3.1 核心业务规则

| 规则ID | 规则描述 | 适用场景 | 实现位置 | 重构要求 |
|--------|----------|----------|----------|----------|
| BR-001 | [业务规则] | [适用场景] | [源代码位置] | [保持/优化] |
| BR-002 | [业务规则] | [适用场景] | [源代码位置] | [保持/优化] |

### 3.2 计算逻辑

| 计算项 | 计算公式 | 输入参数 | 输出结果 | 重构要求 |
|--------|----------|----------|----------|----------|
| [计算名称] | [公式] | [参数列表] | [结果] | [保持/优化] |

### 3.3 验证规则

| 验证项 | 验证规则 | 错误消息 | 触发时机 | 重构要求 |
|--------|----------|----------|----------|----------|
| [验证名称] | [规则描述] | [错误信息] | [触发条件] | [保持/优化] |

---

## 4. 交互模式

### 4.1 用户交互模式

#### 模式1: [交互模式名称]
**描述**: [模式描述]  
**使用场景**: [使用场景]

**交互流程**:
1. 用户: [用户操作]
2. 系统: [系统响应]
3. 用户: [用户操作]
4. 系统: [系统响应]

### 4.2 导航结构

```
[页面1] → [页面2] → [页面3] → [页面4]
    ↓          ↓          ↓
[子页面A]  [子页面B]  [子页面C]
```

**导航规则**:
- [规则1]
- [规则2]

---

## 5. 重构合规性要求

### 5.1 功能保持要求

- [x] **100%业务逻辑保持**: 所有业务规则和计算逻辑必须完全保持
- [x] **用户流程不变**: 用户操作流程和步骤顺序必须保持一致
- [x] **数据流保持**: 数据在系统中的流转路径必须保持一致
- [ ] **UI/UX可优化**: 界面布局和交互体验可以基于新技术栈优化

### 5.2 验证标准

| 验证项目 | 验证方法 | 预期结果 | 优先级 |
|----------|----------|----------|--------|
| 业务逻辑完整性 | 端到端测试 | 100%功能一致 | P0 |
| 用户流程正确性 | 用户验收测试 | 用户无感知差异 | P0 |
| 数据流准确性 | 数据对比测试 | 数据完全一致 | P1 |

### 5.3 用户体验优化点

**允许优化的方面**:
- [ ] 界面响应速度优化
- [ ] 视觉设计现代化
- [ ] 交互体验改进
- [ ] 移动端适配增强
- [ ] 可访问性提升

**禁止变更的方面**:
- [x] 核心业务逻辑
- [x] 数据模型结构
- [x] API调用方式
- [x] 用户操作流程

---

## 6. 重构验证清单

### 6.1 Phase 1: 基线验证
- [ ] 所有用户流程已文档化
- [ ] 业务规则已完整映射
- [ ] 数据流已清晰定义
- [ ] 验收标准已明确

### 6.2 Phase 2: 实现验证
- [ ] 新实现业务逻辑100%一致
- [ ] 用户操作流程完全保持
- [ ] 数据流转路径不变
- [ ] 错误处理行为一致

### 6.3 Phase 3: 用户验收
- [ ] 用户操作无感知差异
- [ ] 业务结果完全一致
- [ ] 性能不劣于原系统
- [ ] UX体验符合预期

---

**文档状态**: [草稿/完成/已验证]  
**最后更新**: [更新日期]  
**更新人**: [更新者]  

---

## 需求技术流程映射 *(推荐)*

### 用户需求与技术流程关联

| 用户需求ID | 需求描述 | 关联技术流程 | 实现方式 | 验证方法 |
|-----------|----------|-------------|----------|----------|
| **US-001** | [来自spec.md的需求描述] | 流程1.1, 流程1.2 | [具体实现方式] | [验证方法] |
| **US-002** | [来自spec.md的需求描述] | 流程2.1, 流程2.3 | [具体实现方式] | [验证方法] |

### 技术流程需求溯源

| 流程编号 | 流程描述 | 支持的用户需求 | 技术优先级 | 复杂度 |
|----------|----------|----------------|------------|--------|
| **1.1** | [流程描述] | US-001, US-003 | High | Medium |
| **2.1** | [流程描述] | US-002 | Medium | Low |

### 实现依赖关系

| 组件/模块 | 依赖项 | 关联需求 | 影响范围 |
|-----------|--------|----------|----------|
| [组件A] | [依赖B] | US-001 | [影响范围] |
| [组件B] | [依赖C] | US-002 | [影响范围] |

---

*本文档与data-models.md和apis.md共同构成重构的完整契约文档*